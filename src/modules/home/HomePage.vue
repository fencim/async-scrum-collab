<template>
  <q-page class="justify-evenly q-pa-sm">
    <q-table grid :rows="projectStore.projects" hide-bottom>
      <template v-slot:item="props">
        <div class="q-pa-xs col-xs-12 col-sm-6 col-md-4">
          <q-card class="cursor-pointer">
            <q-card-section class="text-center">
              <strong>{{ props.row.name }}</strong>
            </q-card-section>
            <q-card-section
              horizontal
              @click="
                hasJoined(props.row)
                  ? $router.replace({
                      name: 'projectHome',
                      params: { project: props.row.key },
                    })
                  : joinProject(props.row.key)
              "
            >
              <q-card-section>
                <q-btn round size="lg" dense>
                  <q-avatar size="xl">
                    <q-img v-if="props.row.icon" :src="props.row.icon" />
                    <q-img
                      v-else
                      src="img:icons/For-Presentation-150x150.png"
                      style="border: 5px solid gray; border-radius: 50px"
                    />
                  </q-avatar>
                </q-btn>
              </q-card-section>
              <q-card-section class="text-subtitle1 q-pa-sm">
                {{ props.row.description }}
              </q-card-section>
            </q-card-section>
            <q-card-actions>
              <q-btn
                v-if="!hasJoined(props.row)"
                @click.prevent="joinProject(props.row.key)"
                >Join</q-btn
              >
              <q-btn
                v-if="isAdminOf(props.row)"
                icon="edit"
                class="rounded"
                @click="
                  TheDialogs.emit({
                    type: 'editProject',
                    arg: {
                      project: props.row,
                    },
                  })
                "
              />
              <q-btn
                v-if="isAdminOf(props.row)"
                icon="settings"
                class="rounded"
                :to="{ name: 'settings', params: { project: props.row.key } }"
              >
                <q-badge floating v-if="props.row.pending?.length">{{
                  props.row.pending?.length
                }}</q-badge>
              </q-btn>
            </q-card-actions>
          </q-card>
        </div>
      </template>
    </q-table>
  </q-page>
</template>

<script lang="ts">
import { TheDialogs } from 'src/dialogs/the-dialogs';
import { IProject } from 'src/entities';
import { useProfilesStore } from 'src/stores/profiles.store';
import { useProjectStore } from 'src/stores/projects.store';
import { defineComponent } from 'vue';
const projectStore = useProjectStore();
const profilesStore = useProfilesStore();

export default defineComponent({
  name: 'IndexPage',
  components: {},
  data() {
    return {
      projectStore,
      TheDialogs,
    };
  },
  methods: {
    hasJoined(project: IProject) {
      return (
        profilesStore.presentUser?.key &&
        [
          ...project.admins,
          ...project.moderators,
          ...project.members,
          ...project.pending,
        ].includes(profilesStore.presentUser?.key)
      );
    },
    isAdminOf(project: IProject) {
      return (
        profilesStore.presentUser?.key &&
        [...project.admins].includes(profilesStore.presentUser?.key)
      );
    },
    async joinProject(projectKey: string) {
      const proj = projectStore.projects.find((p) => p.key == projectKey);
      this.$q.notify({
        position: 'center',
        message: `Join (${projectKey}) ${proj?.name || ''}?`,
        actions: [
          {
            label: 'Proceed',
            icon: 'login',
            handler: async () => {
              if (profilesStore.presentUser) {
                await projectStore.joinProject(
                  projectKey,
                  profilesStore.presentUser?.key
                );
                await this.$router.replace({
                  name: 'projectHome',
                  params: {
                    project: projectKey,
                  },
                });
              }
            },
          },
        ],
      });
    },
  },
});
</script>
<style></style>
